<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora iPhone · Display duplo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, 'Helvetica Neue', 'SF Pro Display', sans-serif;
        }

        body {
            background: #1c1c1e;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
            padding: 16px;
        }

        .iphone-calculator {
            width: 340px;
            background: #000000;
            border-radius: 48px;
            padding: 20px 16px 28px 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.8), 0 0 0 2px rgba(255, 255, 255, 0.05) inset;
        }

        /* novo display duplo: histórico/expressão + resultado */
        .display-duplo {
            background: transparent;
            padding: 12px 10px 8px 10px;
            margin-bottom: 8px;
            border-radius: 16px;
        }

        #expressao {
            width: 100%;
            background: transparent;
            border: none;
            outline: none;
            text-align: right;
            font-size: 24px;
            font-weight: 300;
            color: #a5a5a5;  /* cinza claro para o histórico */
            letter-spacing: 0px;
            line-height: 1.2;
            padding: 4px 0;
            white-space: nowrap;
            overflow-x: auto;
            direction: rtl;  /* rolagem natural para números grandes */
            font-feature-settings: "tnum";
        }

        #expressao::-webkit-scrollbar {
            height: 2px;
            background: #222;
        }
        #expressao::-webkit-scrollbar-thumb {
            background: #ff9f0a;
            border-radius: 4px;
        }

        #resultado {
            width: 100%;
            background: transparent;
            border: none;
            outline: none;
            text-align: right;
            font-size: 70px;
            font-weight: 300;
            color: white;
            letter-spacing: -1px;
            line-height: 1.1;
            padding: 8px 0;
            caret-color: #ff9f0a;
            font-feature-settings: "tnum";
        }

        #resultado::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        .botoes-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .btn {
            aspect-ratio: 1 / 1;
            border: none;
            border-radius: 9999px;
            font-size: 32px;
            font-weight: 400;
            background: #333333;
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            padding: 0 6px;
        }

        .btn.operador {
            background: #ff9f0a;
            color: white;
            font-size: 40px;
            font-weight: 500;
        }

        .btn.funcao {
            background: #a5a5a5;
            color: black;
            font-size: 28px;
            font-weight: 500;
        }

        .btn.zero {
            grid-column: span 2;
            aspect-ratio: auto;
            justify-content: flex-start;
            padding-left: 30px;
        }

        /* ajustes específicos para símbolos */
        .btn[data-value="÷"] { font-size: 44px; padding-bottom: 6px; }
        .btn[data-value="×"] { font-size: 36px; }
        .btn[data-value="−"] { font-size: 48px; font-weight: 300; padding-bottom: 8px; }
        .btn[data-value="+"] { font-size: 40px; font-weight: 300; }
        .btn[data-value="="] { font-size: 40px; background: #ff9f0a; }

        .btn:active {
            filter: brightness(1.5);
            transform: scale(0.96);
        }

        .btn.operador:active {
            filter: brightness(1.2);
            background: #ffb84d;
        }

        .btn.funcao:active {
            background: #cecece;
        }
    </style>
</head>
<body>
    <div class="iphone-calculator">
        <!-- DISPLAY DUPLO: expressão (mostra a conta) + resultado -->
        <div class="display-duplo">
            <input type="text" id="expressao" readonly placeholder=" " value=" " aria-label="Expressão da conta">
            <input type="text" id="resultado" readonly placeholder="0" value="0" aria-label="Resultado">
        </div>

        <div class="botoes-grid">
            <button class="btn funcao" data-value="AC">AC</button>
            <button class="btn funcao" data-value="+/-">+/-</button>
            <button class="btn funcao" data-value="%">%</button>
            <button class="btn operador" data-value="÷">÷</button>

            <button class="btn" data-value="7">7</button>
            <button class="btn" data-value="8">8</button>
            <button class="btn" data-value="9">9</button>
            <button class="btn operador" data-value="×">×</button>

            <button class="btn" data-value="4">4</button>
            <button class="btn" data-value="5">5</button>
            <button class="btn" data-value="6">6</button>
            <button class="btn operador" data-value="−">−</button>

            <button class="btn" data-value="1">1</button>
            <button class="btn" data-value="2">2</button>
            <button class="btn" data-value="3">3</button>
            <button class="btn operador" data-value="+">+</button>

            <button class="btn zero" data-value="0">0</button>
            <button class="btn" data-value=".">,</button>
            <button class="btn operador" data-value="=">=</button>
        </div>
    </div>

    <script>
        (function() {
            const resultInput = document.getElementById('resultado');
            const expressaoInput = document.getElementById('expressao');
            
            let currentInput = '0';            // valor atual (sempre mostrado no resultado)
            let pendingOperator = null;         // operador pendente
            let previousValue = null;            // primeiro operando
            let resetInputOnNextDigit = false;   // começar novo número

            // ---- CONTROLE DA EXPRESSÃO VISÍVEL ----
            // Guarda a expressão formatada para o display superior
            let expressaoAtual = '';

            function atualizarExpressao(novaExpr) {
                expressaoAtual = novaExpr;
                expressaoInput.value = expressaoAtual || ' ';
            }

            // Atualiza display do resultado
            function updateDisplay(value) {
                let str = value.toString();
                if (str.length > 12 && !str.includes('e')) {
                    str = parseFloat(value).toExponential(6);
                }
                resultInput.value = str;
            }

            // ---- Funções principais adaptadas para mostrar a conta ----

            // Quando um dígito é pressionado
            function handleDigit(digit) {
                if (resetInputOnNextDigit) {
                    currentInput = digit === '.' ? '0.' : digit;
                    resetInputOnNextDigit = false;
                    // ao iniciar novo número, a expressão mantém o operador, mas vamos atualizar depois
                } else {
                    if (digit === '.') {
                        if (currentInput.includes('.')) return;
                        currentInput = currentInput === '' || currentInput === '0' ? '0.' : currentInput + '.';
                    } else {
                        if (currentInput === '0' && digit !== '0') {
                            currentInput = digit;
                        } else if (currentInput === '0' && digit === '0') {
                            return;
                        } else {
                            currentInput += digit;
                        }
                    }
                }

                // Atualiza a expressão conforme o contexto
                if (previousValue !== null && pendingOperator && !resetInputOnNextDigit) {
                    // Estamos digitando o segundo número: mostra previous + operador + digitação parcial
                    atualizarExpressao(previousValue + ' ' + pendingOperator + ' ' + currentInput);
                } else if (previousValue !== null && !pendingOperator) {
                    // após igual, se digitou novo número, mostra só o número
                    atualizarExpressao(currentInput);
                } else if (previousValue === null) {
                    // primeiro número sendo digitado
                    atualizarExpressao(currentInput);
                }

                updateDisplay(currentInput);
            }

            function setOperator(op) {
                // Se já há operador pendente e não estamos no início, calcular antes (exceto se vier de '=' )
                if (pendingOperator !== null && !resetInputOnNextDigit) {
                    evaluate(false); // false = não mostrar igual na expressão ainda
                }

                const currentNum = parseFloat(currentInput);
                
                if (previousValue === null) {
                    previousValue = currentNum;
                    // Mostra na expressão: primeiro número + operador
                    atualizarExpressao(previousValue + ' ' + op);
                } else {
                    // Se já tinha previous (após eval ou anterior), só atualiza expressão
                    atualizarExpressao(previousValue + ' ' + op);
                }

                pendingOperator = op;
                resetInputOnNextDigit = true;
                // currentInput mantém o último número, mas não é mostrado na expressão até digitar
            }

            function evaluate(showEqual = true) {
                if (pendingOperator === null || previousValue === null) return;

                const currentNum = parseFloat(currentInput);
                let newValue = 0;
                let operacaoValida = true;

                // Monta expressão bonita para mostrar antes do resultado
                let expressaoCompleta = previousValue + ' ' + pendingOperator + ' ' + currentNum;
                if (showEqual) expressaoCompleta += ' =';

                switch (pendingOperator) {
                    case '+': newValue = previousValue + currentNum; break;
                    case '−': newValue = previousValue - currentNum; break;
                    case '×': newValue = previousValue * currentNum; break;
                    case '÷':
                        if (currentNum === 0) {
                            currentInput = 'Erro';
                            updateDisplay(currentInput);
                            atualizarExpressao(expressaoCompleta); // mostra a conta que deu erro
                            previousValue = null;
                            pendingOperator = null;
                            resetInputOnNextDigit = true;
                            return;
                        } else {
                            newValue = previousValue / currentNum;
                        }
                        break;
                    default: return;
                }

                // Arredondamento para evitar imprecisões
                if (Math.abs(newValue) > 1e12) {
                    currentInput = newValue.toExponential(6);
                } else {
                    currentInput = parseFloat(newValue.toFixed(10)).toString();
                }

                // Atualiza expressão com o resultado completo
                atualizarExpressao(expressaoCompleta + ' ' + currentInput);
                updateDisplay(currentInput);

                previousValue = newValue;
                pendingOperator = null;      // limpa operador (como iOS após '=')
                resetInputOnNextDigit = true;
            }

            function allClear() {
                currentInput = '0';
                pendingOperator = null;
                previousValue = null;
                resetInputOnNextDigit = false;
                atualizarExpressao('');
                updateDisplay(currentInput);
            }

            function toggleSign() {
                if (currentInput === 'Erro') { allClear(); return; }
                let num = parseFloat(currentInput);
                num = num * -1;
                currentInput = num.toString();
                updateDisplay(currentInput);
                // Atualiza expressão se for o primeiro número ou segundo
                if (previousValue !== null && pendingOperator) {
                    atualizarExpressao(previousValue + ' ' + pendingOperator + ' ' + currentInput);
                } else {
                    atualizarExpressao(currentInput);
                }
            }

            function percent() {
                if (currentInput === 'Erro') { allClear(); return; }
                let currentNum = parseFloat(currentInput);
                if (isNaN(currentNum)) currentNum = 0;

                if (previousValue !== null && pendingOperator) {
                    if (pendingOperator === '+' || pendingOperator === '−') {
                        currentNum = (previousValue * currentNum) / 100;
                    } else if (pendingOperator === '×' || pendingOperator === '÷') {
                        currentNum = currentNum / 100;
                    } else {
                        currentNum = currentNum / 100;
                    }
                } else {
                    currentNum = currentNum / 100;
                }

                currentInput = currentNum.toString();
                updateDisplay(currentInput);

                // atualiza expressão
                if (previousValue !== null && pendingOperator) {
                    atualizarExpressao(previousValue + ' ' + pendingOperator + ' ' + currentInput);
                } else {
                    atualizarExpressao(currentInput);
                }
                resetInputOnNextDigit = true;
            }

            function handleEqual() {
                if (pendingOperator && previousValue !== null) {
                    evaluate(true); // true = mostra '=' na expressão
                } else {
                    // Se não há operador, só copia currentInput e mantém
                    resetInputOnNextDigit = true;
                    atualizarExpressao(currentInput);
                }
            }

            // ---- Roteamento de botões ----
            function handleButton(value) {
                if (currentInput === 'Erro' && value !== 'AC') {
                    if (value === 'AC') allClear();
                    return;
                }

                switch (value) {
                    case 'AC': allClear(); break;
                    case '+/-': toggleSign(); break;
                    case '%': percent(); break;
                    case '÷': case '×': case '−': case '+': setOperator(value); break;
                    case '=': handleEqual(); break;
                    case '.': handleDigit('.'); break;
                    default:
                        if (/\d/.test(value)) handleDigit(value);
                        break;
                }
            }

            // ---- Eventos de clique ----
            document.querySelectorAll('.btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const valor = btn.getAttribute('data-value');
                    handleButton(valor);
                });
            });

            // ---- Teclado físico (opcional) ----
            window.addEventListener('keydown', (e) => {
                const key = e.key;
                const teclasPermitidas = ['0','1','2','3','4','5','6','7','8','9','.','%','/','*','-','+','=','Enter','Escape','c','C'];
                if (teclasPermitidas.includes(key) || key === 'Escape') {
                    e.preventDefault();
                    if (key === 'Escape' || key === 'c' || key === 'C') handleButton('AC');
                    else if (key === '%') handleButton('%');
                    else if (key === '/') handleButton('÷');
                    else if (key === '*') handleButton('×');
                    else if (key === '-') handleButton('−');
                    else if (key === '+') handleButton('+');
                    else if (key === 'Enter' || key === '=') handleButton('=');
                    else if (key === '.') handleButton('.');
                    else if (key >= '0' && key <= '9') handleButton(key);
                }
            });

            // Inicialização
            allClear(); // já deixa expressão vazia e resultado 0
        })();
    </script>
</body>
</html>
